<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Interview - Professional Assessment Platform</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="interview.css" />
  </head>
  <body>
    <!-- Background Effects -->
    <div class="bg-overlay"></div>
    <div class="geometric-shapes">
      <div class="shape circle"></div>
      <div class="shape square"></div>
      <div class="shape circle"></div>
      <div class="shape square"></div>
      <div class="shape circle"></div>
    </div>

    <!-- Header -->
    <header class="header">
      <div class="nav-container">
        <div class="logo">
          <div class="logo-icon">AI</div>
          Interview Platform
        </div>
        <div class="interview-badge">
          <div class="status-dot"></div>
          Live Assessment Ready
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
      <!-- Interview Panel -->
      <section class="interview-panel">
        <div class="welcome-section">
          <h1 class="interview-title">AI Interview</h1>
          <p class="interview-subtitle">Professional Technical Assessment</p>
          <p class="interview-description">
            Welcome to your personalized AI interview session. Our advanced AI
            interviewer will assess your skills through natural conversation.
            Please ensure you're in a quiet environment with a working
            microphone.
          </p>
        </div>

        <div class="voice-interface">
          <div class="voice-status-display" id="voiceStatusDisplay">
            <div class="status-header">
              <div class="status-indicator" id="statusIndicator"></div>
              <div class="status-text" id="statusText">Ready to begin</div>
              <div class="loader" id="loader" style="display: none"></div>
            </div>

            <div class="session-timer" id="sessionTimer">00:00</div>

            <div
              class="voice-visualizer-container"
              id="voiceVisualizerContainer"
              style="display: none"
            >
              <div class="voice-visualizer" id="voiceVisualizer">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
              </div>
            </div>
          </div>

          <div class="interview-controls">
            <button class="btn btn-start" id="startBtn">
              <svg
                class="btn-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                />
              </svg>
              Start Interview
            </button>
            <button class="btn btn-end" id="endBtn" disabled>
              <svg
                class="btn-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 3l-6 6m0 0V4m0 5h5M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"
                />
              </svg>
              End Interview
            </button>
          </div>
        </div>
      </section>

      <!-- Transcription Panel -->
      <aside class="transcription-panel">
        <div class="transcription-header">
          <div class="transcription-title">
            <div class="transcription-icon">üìù</div>
            Live Transcription
          </div>
          <div class="live-status" id="liveStatus" style="display: none">
            <div class="live-indicator"></div>
            Live Recording
          </div>
        </div>

        <div class="transcription-content" id="transcriptionContent">
          <div class="empty-state">
            <div class="empty-icon">üé§</div>
            <div class="empty-text">
              Conversation will appear here once the interview starts
            </div>
          </div>
        </div>

        <div class="stats-footer">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="totalTime">00:00</div>
              <div class="stat-label">Duration</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="wordsSpoken">0</div>
              <div class="stat-label">Words</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="exchanges">0</div>
              <div class="stat-label">Exchanges</div>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <!-- Load Retell SDK -->
    <script src="js/retell-sdk.bundle.js"></script>
    <script>
      class AIInterviewSystem {
        constructor() {
          this.client = null;
          this.startTime = null;
          this.timer = null;
          this.wordsCount = 0;
          this.exchangeCount = 0;
          this.isActive = false;

          this.elements = {
            startBtn: document.getElementById("startBtn"),
            endBtn: document.getElementById("endBtn"),
            voiceStatusDisplay: document.getElementById("voiceStatusDisplay"),
            statusIndicator: document.getElementById("statusIndicator"),
            statusText: document.getElementById("statusText"),
            sessionTimer: document.getElementById("sessionTimer"),
            voiceVisualizerContainer: document.getElementById(
              "voiceVisualizerContainer"
            ),
            voiceVisualizer: document.getElementById("voiceVisualizer"),
            transcriptionContent: document.getElementById(
              "transcriptionContent"
            ),
            liveStatus: document.getElementById("liveStatus"),
            totalTime: document.getElementById("totalTime"),
            wordsSpoken: document.getElementById("wordsSpoken"),
            exchanges: document.getElementById("exchanges"),
            loader: document.getElementById("loader"),
          };

          this.init();
        }

        init() {
          this.elements.startBtn.onclick = () => this.startInterview();
          this.elements.endBtn.onclick = () => this.endInterview();
        }

        showLoader() {
          this.elements.loader.style.display = "inline-block";
        }

        hideLoader() {
          this.elements.loader.style.display = "none";
        }

        updateStatus(status, text) {
          this.elements.voiceStatusDisplay.className = `voice-status-display status-${status}`;
          this.elements.statusText.textContent = text;

          if (status === "connecting") {
            this.showLoader();
          } else {
            this.hideLoader();
          }

          if (status === "active") {
            this.elements.voiceVisualizerContainer.style.display = "flex";
            this.elements.voiceVisualizer.className = "voice-visualizer active";
            this.elements.liveStatus.style.display = "flex";
          } else {
            this.elements.voiceVisualizerContainer.style.display = "none";
            this.elements.liveStatus.style.display = "none";
          }
        }

        startTimer() {
          this.startTime = Date.now();
          this.timer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeString = `${minutes.toString().padStart(2, "0")}:${seconds
              .toString()
              .padStart(2, "0")}`;
            this.elements.sessionTimer.textContent = timeString;
            this.elements.totalTime.textContent = timeString;
          }, 1000);
        }

        stopTimer() {
          if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
          }
        }

        clearTranscription() {
          this.elements.transcriptionContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üé§</div>
                        <div class="empty-text">Conversation will appear here once the interview starts</div>
                    </div>
                `;
        }

        addTranscription(speaker, text, isPartial = false) {
          // Validate inputs
          if (!speaker || !text || typeof text !== "string" || !text.trim()) {
            console.log("Invalid transcription data, skipping:", {
              speaker,
              text,
              isPartial,
            });
            return;
          }

          // Remove empty state if it exists
          const emptyState =
            this.elements.transcriptionContent.querySelector(".empty-state");
          if (emptyState) {
            emptyState.remove();
          }

          const now = new Date();
          const timestamp = `${now.getHours().toString().padStart(2, "0")}:${now
            .getMinutes()
            .toString()
            .padStart(2, "0")}:${now.getSeconds().toString().padStart(2, "0")}`;

          // Check if this is an update to the last entry (for partial transcripts)
          const lastEntry = this.elements.transcriptionContent.lastElementChild;
          const isUpdate =
            lastEntry && lastEntry.classList.contains(speaker) && isPartial;

          if (isUpdate) {
            // Update existing entry
            const textElement = lastEntry.querySelector(".transcript-text");
            if (textElement) {
              textElement.textContent = text.trim();
            }
          } else {
            // Create new entry
            const entry = document.createElement("div");
            entry.className = `transcription-entry ${speaker}`;

            const speakerName =
              speaker === "ai-interviewer" ? "AI Interviewer" : "Candidate";
            const avatar = speaker === "ai-interviewer" ? "AI" : "C";

            entry.innerHTML = `
                        <div class="transcript-header">
                            <div class="speaker-info">
                                <div class="speaker-avatar">${avatar}</div>
                                <div class="speaker-name">${speakerName}</div>
                            </div>
                            <div class="timestamp">${timestamp}</div>
                        </div>
                        <div class="transcript-text">${text.trim()}</div>
                    `;

            this.elements.transcriptionContent.appendChild(entry);

            // Update stats only for complete entries
            if (!isPartial) {
              this.exchangeCount++;
              this.elements.exchanges.textContent = this.exchangeCount;

              if (speaker === "candidate") {
                const words = text
                  .trim()
                  .split(/\s+/)
                  .filter((word) => word.length > 0);
                this.wordsCount += words.length;
                this.elements.wordsSpoken.textContent = this.wordsCount;
              }
            }
          }

          // Auto-scroll to bottom
          this.elements.transcriptionContent.scrollTop =
            this.elements.transcriptionContent.scrollHeight;
        }

        async getToken() {
          try {
            const response = await fetch("/api/retell/create-web-call", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              // agentId is now handled in the backend
            });

            if (!response.ok) {
              throw new Error("Failed to connect to interview service");
            }

            const data = await response.json();
            return data.access_token;
          } catch (error) {
            console.error("Token fetch error:", error);
            throw new Error("Unable to connect to interview service");
          }
        }

        async startInterview() {
          try {
            this.updateStatus("connecting", "Connecting to AI interviewer");
            this.elements.startBtn.disabled = true;

            const token = await this.getToken();

            this.client = window.createRetellClient();

            this.client.on("call_started", () => {
              this.updateStatus("active", "Interview in progress");
              this.elements.endBtn.disabled = false;
              this.startTimer();
              this.isActive = true;
              this.clearTranscription();
            });

            this.client.on("call_ended", () => {
              this.updateStatus("idle", "Interview completed");
              this.elements.startBtn.disabled = false;
              this.elements.endBtn.disabled = true;
              this.stopTimer();
              this.isActive = false;

              // Add completion message
              this.addTranscription(
                "ai-interviewer",
                "Interview session completed. Thank you for your time!"
              );

              // Navigate to dashboard with results after a short delay
              setTimeout(() => {
                window.location.href = "interview-generator.html";
              }, 3000);
            });

            this.client.on("update", (update) => {
              try {
                // Handle real-time transcription from Retell AI
                if (update.transcript && update.transcript.trim()) {
                  const transcript = update.transcript.trim();

                  // Determine speaker based on Retell AI update
                  // This is a simplified approach - in production you'd have more sophisticated speaker detection
                  const speaker = this.determineSpeaker(update);

                  // Add transcription entry
                  this.addTranscription(
                    speaker,
                    transcript,
                    update.is_partial || false
                  );
                }
              } catch (error) {
                console.error("Transcription update error:", error);
              }
            });

            this.client.on("error", (error) => {
              console.error("Interview system error:", error);
              this.updateStatus("idle", "Connection lost");
              this.elements.startBtn.disabled = false;
              this.elements.endBtn.disabled = true;
              this.stopTimer();
              this.isActive = false;
            });

            await this.client.startCall({
              accessToken: token,
              sampleRate: 24000,
            });
          } catch (error) {
            console.error("Start interview error:", error);
            this.updateStatus("idle", "Failed to start interview");
            this.elements.startBtn.disabled = false;
            this.elements.endBtn.disabled = true;
          }
        }

        endInterview() {
          if (this.client && this.isActive) {
            try {
              this.client.stopCall();
            } catch (error) {
              console.error("End interview error:", error);
              // Force UI reset
              this.updateStatus("idle", "Interview ended");
              this.elements.startBtn.disabled = false;
              this.elements.endBtn.disabled = true;
              this.stopTimer();
              this.isActive = false;
            }
          }
        }

        determineSpeaker(update) {
          // Simple speaker detection logic
          // In a real implementation, this would be more sophisticated
          // You might use update.role, update.speaker, or analyze the content

          // For now, we'll use a simple heuristic:
          // If it's a question or starts with common AI interviewer phrases, it's the interviewer
          const text = update.transcript.toLowerCase();
          const interviewerPhrases = [
            "tell me about",
            "can you explain",
            "what is your",
            "how do you",
            "describe your",
            "what would you",
            "why did you",
            "how would you",
          ];

          const isQuestion = text.includes("?");
          const hasInterviewerPhrase = interviewerPhrases.some((phrase) =>
            text.includes(phrase)
          );

          if (isQuestion || hasInterviewerPhrase) {
            return "ai-interviewer";
          } else {
            return "candidate";
          }
        }
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        try {
          new AIInterviewSystem();
        } catch (error) {
          console.error("Interview system initialization error:", error);
          document.getElementById("statusText").textContent =
            "System initialization error";
        }
      });
    </script>

    <!-- Production-Level Code Protection -->
    <script>
      // Disable Right-Click Context Menu
      document.addEventListener("contextmenu", function (event) {
        event.preventDefault();
        return false;
      });

      // Disable Key Combinations
      document.addEventListener("keydown", function (event) {
        // Disable F12
        if (event.keyCode == 123) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+U (View Source)
        if (event.ctrlKey && event.keyCode == 85) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+Shift+I (Developer Tools)
        if (event.ctrlKey && event.shiftKey && event.keyCode == 73) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+Shift+C (Element Inspector)
        if (event.ctrlKey && event.shiftKey && event.keyCode == 67) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+S (Save Page)
        if (event.ctrlKey && event.keyCode == 83) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+A (Select All) + Ctrl+C (Copy)
        if (event.ctrlKey && event.keyCode == 65) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+P (Print)
        if (event.ctrlKey && event.keyCode == 80) {
          event.preventDefault();
          return false;
        }

        // Disable Ctrl+Shift+J (Console)
        if (event.ctrlKey && event.shiftKey && event.keyCode == 74) {
          event.preventDefault();
          return false;
        }
      });

      // Detect Developer Tools
      let devtools = {
        isOpen: false,
        orientation: null,
      };

      const threshold = 160;
      setInterval(() => {
        if (
          window.outerHeight - window.innerHeight > threshold ||
          window.outerWidth - window.innerWidth > threshold
        ) {
          if (!devtools.isOpen) {
            devtools.isOpen = true;
            console.clear();
            console.log(
              "%cStop!",
              "color: red; font-size: 40px; font-weight: bold;"
            );
            console.log(
              "%cThis is a browser feature intended for developers. If someone told you to copy-paste something here, it is likely an attempt to compromise your security.",
              "color: red; font-size: 14px;"
            );
          }
        } else {
          devtools.isOpen = false;
        }
      }, 500);

      // Anti-Debugging
      let ok = false;
      setInterval(() => {
        if (!ok) {
          ok = true;
          console.clear();
          console.log(
            "%cAccess Denied!",
            "color: red; font-size: 50px; font-weight: bold;"
          );
          console.log(
            "%cDeveloper tools are not allowed in this application.",
            "color: red; font-size: 16px;"
          );
        } else {
          ok = false;
        }
      }, 1000);

      // Disable Selection
      document.addEventListener("selectstart", function (event) {
        event.preventDefault();
        return false;
      });

      // Disable Drag
      document.addEventListener("dragstart", function (event) {
        event.preventDefault();
        return false;
      });

      // Hide on DevTools Detection
      function hidePage() {
        document.body.style.display = "none";
        setTimeout(() => {
          document.body.style.display = "block";
        }, 100);
      }

      setInterval(() => {
        if (devtools.isOpen) {
          hidePage();
        }
      }, 1000);

      // Console Warning
      console.warn =
        console.error =
        console.info =
        console.debug =
          function () {
            // Silently block console output
          };

      // Clear console on load
      console.clear();
    </script>
  </body>
</html>
